name: Daily Predictions & Accuracy Tracking

on:
  schedule:
    # Run twice daily during basketball season:
    # - 10 AM ET (3 PM UTC) - Collect odds for evening games
    # - 11 PM ET (4 AM UTC next day) - Check results from completed games
    - cron: '0 15 * * *'  # 10 AM ET / 3 PM UTC
    - cron: '0 4 * * *'   # 11 PM ET / 4 AM UTC
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'both'
        type: choice
        options:
          - collect_odds
          - check_results
          - both
          - update_readme

env:
  PYTHON_VERSION: '3.10'

jobs:
  collect-odds:
    name: Collect Odds & Generate Predictions
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'collect_odds' || github.event.inputs.action == 'both') || github.event.schedule == '0 15 * * *'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create .env file
        run: |
          echo "THE_ODDS_API_KEY=${{ secrets.THE_ODDS_API_KEY }}" > .env
          echo "BASKETBALL_API_KEY=${{ secrets.BASKETBALL_API_KEY }}" >> .env
      
      - name: Create data directory
        run: mkdir -p data

      - name: Download KenPom summary (optional)
        run: |
          if [ -n "${KENPOM_SUMMARY_URL}" ]; then
            season_full=$(python - <<'PY'
          import config
          print(config.CURRENT_SEASON)
          PY
          )
            season_short=$(python - <<'PY'
          import config
          print(f"{config.CURRENT_SEASON % 100:02d}")
          PY
          )
            url="${KENPOM_SUMMARY_URL}"
            url="${url//\{season_short\}/${season_short}}"
            url="${url//\{season\}/${season_short}}"
            url="$(echo "${url}" | sed -E "s/summary[0-9]+/summary${season_short}/")"
            echo "Downloading KenPom summary..."
            if [ -n "${KENPOM_COOKIE}" ]; then
              curl -fL -o "data/summary${season_short}.csv" -b "${KENPOM_COOKIE}" "${url}"
            else
              curl -fL -o "data/summary${season_short}.csv" "${url}"
            fi
            cp "data/summary${season_short}.csv" "data/summary${season_full}.csv"
            echo "KenPom summary saved to data/summary${season_short}.csv"
          else
            echo "KENPOM_SUMMARY_URL not set; skipping KenPom download"
          fi
        env:
          KENPOM_SUMMARY_URL: ${{ secrets.KENPOM_SUMMARY_URL }}
          KENPOM_COOKIE: ${{ secrets.KENPOM_COOKIE }}
      
      - name: Download existing ATS data
        uses: actions/cache@v4
        with:
          path: |
            data/ats_tracking.json
            data/ats_accuracy.json
            data/predictions.json
            data/results.json
          key: ats-data-${{ github.run_number }}
          restore-keys: |
            ats-data-
      
      - name: Cache ML models
        uses: actions/cache@v4
        with:
          path: |
            data/models
          key: ml-models-${{ github.run_number }}
          restore-keys: |
            ml-models-
      
      - name: Collect Odds and Generate Predictions
        run: python scripts/predict_today.py --days 2
      
      - name: Upload ATS Data
        uses: actions/upload-artifact@v4
        with:
          name: ats-data-${{ github.run_number }}
          path: |
            data/ats_tracking.json
            data/ats_accuracy.json
          retention-days: 90
      
      - name: Commit ATS Data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/ats_tracking.json data/ats_accuracy.json README.md || true
          git diff --staged --quiet || git commit -m "üìä Update predictions for $(date +%Y-%m-%d)"
          git push || echo "Nothing to push"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  check-results:
    name: Check Results & Update Accuracy
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'check_results' || github.event.inputs.action == 'both') || github.event.schedule == '0 4 * * *'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create .env file
        run: |
          echo "THE_ODDS_API_KEY=${{ secrets.THE_ODDS_API_KEY }}" > .env
          echo "BASKETBALL_API_KEY=${{ secrets.BASKETBALL_API_KEY }}" >> .env
      
      - name: Download existing ATS data
        uses: actions/cache@v4
        with:
          path: |
            data/ats_tracking.json
            data/ats_accuracy.json
            data/predictions.json
            data/results.json
          key: ats-data-${{ github.run_number }}
          restore-keys: |
            ats-data-

      - name: Cache ML models
        uses: actions/cache@v4
        with:
          path: |
            data/models
          key: ml-models-${{ github.run_number }}
          restore-keys: |
            ml-models-
      
      - name: Check Results
        run: python scripts/daily_check_results.py --days 7
      
      - name: Update README
        run: python scripts/update_readme_accuracy.py

      - name: Retrain ML model
        run: python scripts/setup_and_train.py --populate 200 --train
      
      - name: Upload Updated ATS Data
        uses: actions/upload-artifact@v4
        with:
          name: ats-data-results-${{ github.run_number }}
          path: |
            data/ats_tracking.json
            data/ats_accuracy.json
          retention-days: 90
      
      - name: Commit Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/ats_tracking.json data/ats_accuracy.json README.md || true
          git diff --staged --quiet || git commit -m "üìà Update accuracy stats: $(date +%Y-%m-%d)"
          git push || echo "Nothing to push"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-readme-only:
    name: Update README Only
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'update_readme'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download existing ATS data
        uses: actions/cache@v4
        with:
          path: |
            data/ats_tracking.json
            data/ats_accuracy.json
          key: ats-data-${{ github.run_number }}
          restore-keys: |
            ats-data-

      - name: Cache ML models
        uses: actions/cache@v4
        with:
          path: |
            data/models
          key: ml-models-${{ github.run_number }}
          restore-keys: |
            ml-models-
      
      - name: Update README
        run: python scripts/update_readme_accuracy.py
      
      - name: Commit README
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md || true
          git diff --staged --quiet || git commit -m "üìù Update README accuracy section"
          git push || echo "Nothing to push"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

