name: Daily Predictions & Accuracy Tracking

on:
  schedule:
    # Run twice daily during basketball season:
    # - 10 AM ET (3 PM UTC) - Collect odds for evening games
    # - 11 PM ET (4 AM UTC next day) - Check results from completed games
    - cron: '0 15 * * *'  # 10 AM ET / 3 PM UTC
    - cron: '0 4 * * *'   # 11 PM ET / 4 AM UTC
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'both'
        type: choice
        options:
          - collect_odds
          - check_results
          - both
          - update_readme

env:
  PYTHON_VERSION: '3.10'

jobs:
  collect-odds:
    name: Collect Odds & Generate Predictions
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'collect_odds' || github.event.inputs.action == 'both') || github.event.schedule == '0 15 * * *'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright (KenPom login)
        run: |
          pip install playwright
          python -m playwright install --with-deps chromium

      - name: Login to KenPom and export cookie
        run: |
          if [ -n "${KENPOM_COOKIE}" ]; then
            echo "KENPOM_COOKIE already set; skipping login"
          elif [ -n "${KENPOM_USERNAME}" ] && [ -n "${KENPOM_PASSWORD}" ]; then
            python - <<'PY'
          import os
          import sys
          from playwright.sync_api import sync_playwright

          username = os.getenv("KENPOM_USERNAME")
          password = os.getenv("KENPOM_PASSWORD")
          if not username or not password:
              print("KENPOM_USERNAME or KENPOM_PASSWORD not set; skipping login")
              raise SystemExit(0)

          def fill_first(page, selectors, value):
              for selector in selectors:
                  locator = page.locator(selector)
                  if locator.count() > 0:
                      locator.first.fill(value)
                      return True
              return False

          with sync_playwright() as p:
              browser = p.chromium.launch(headless=True)
              context = browser.new_context()
              page = context.new_page()
              page.goto("https://kenpom.com/login.php", wait_until="domcontentloaded")

              if not fill_first(page, ["input[name='email']", "input[name='username']", "input[name='user']", "input[type='email']"], username):
                  print("Could not find username field on KenPom login page.")
                  sys.exit(1)
              if not fill_first(page, ["input[name='password']", "input[type='password']"], password):
                  print("Could not find password field on KenPom login page.")
                  sys.exit(1)

              submitted = False
              for selector in ["input[type='submit']", "button[type='submit']", "input[value*='Login']", "button:has-text('Login')"]:
                  locator = page.locator(selector)
                  if locator.count() > 0:
                      locator.first.click()
                      submitted = True
                      break
              if not submitted:
                  page.keyboard.press("Enter")

              try:
                  page.wait_for_load_state("networkidle", timeout=15000)
              except Exception:
                  pass

              cookies = context.cookies("https://kenpom.com/")
              cookie_str = "; ".join([f"{cookie['name']}={cookie['value']}" for cookie in cookies])
              if not cookie_str:
                  print("KenPom login did not yield cookies; aborting.")
                  sys.exit(1)

              env_file = os.getenv("GITHUB_ENV")
              if env_file:
                  with open(env_file, "a") as f:
                      f.write(f"KENPOM_COOKIE={cookie_str}\n")
              print("KenPom cookie exported.")
              browser.close()
          PY
          else
            echo "KENPOM_USERNAME or KENPOM_PASSWORD not set; skipping KenPom login"
          fi
        env:
          KENPOM_USERNAME: ${{ secrets.KENPOM_USERNAME }}
          KENPOM_PASSWORD: ${{ secrets.KENPOM_PASSWORD }}
      
      - name: Create .env file
        run: |
          echo "THE_ODDS_API_KEY=${{ secrets.THE_ODDS_API_KEY }}" > .env
          echo "BASKETBALL_API_KEY=${{ secrets.BASKETBALL_API_KEY }}" >> .env
      
      - name: Create data directory
        run: mkdir -p data

      - name: Download KenPom summary (optional)
        run: |
          if [ -n "${KENPOM_SUMMARY_URL}" ] && [ -n "${KENPOM_COOKIE}" ]; then
            season_full=$(python - <<'PY'
          import config
          print(config.CURRENT_SEASON)
          PY
          )
            season_short=$(python - <<'PY'
          import config
          print(f"{config.CURRENT_SEASON % 100:02d}")
          PY
          )
            url="${KENPOM_SUMMARY_URL}"
            url="${url//\{season_short\}/${season_short}}"
            url="${url//\{season\}/${season_short}}"
            url="$(echo "${url}" | sed -E "s/summary[0-9]+/summary${season_short}/")"
            echo "Downloading KenPom summary..."
            curl_args=(
              -fL
              --retry 3
              --retry-delay 5
              --retry-connrefused
              --retry-all-errors
              --http1.1
              -H "User-Agent: Mozilla/5.0"
              -H "Referer: https://kenpom.com/"
              -o "data/summary${season_short}.csv"
            )
            curl "${curl_args[@]}" -b "${KENPOM_COOKIE}" "${url}" || echo "KenPom download failed; continuing without summary CSV."
            if [ -f "data/summary${season_short}.csv" ]; then
              cp "data/summary${season_short}.csv" "data/summary${season_full}.csv"
              echo "KenPom summary saved to data/summary${season_short}.csv"
            else
              echo "KenPom summary not available; skipping copy."
            fi
          else
            echo "KENPOM_SUMMARY_URL or KENPOM_COOKIE not set; skipping KenPom download"
          fi
        env:
          KENPOM_SUMMARY_URL: ${{ secrets.KENPOM_SUMMARY_URL }}
      
      - name: Download existing ATS data
        uses: actions/cache@v4
        with:
          path: |
            data/ats_tracking.json
            data/ats_accuracy.json
            data/predictions.json
            data/results.json
          key: ats-data-${{ github.run_number }}
          restore-keys: |
            ats-data-
      
      - name: Cache ML models
        uses: actions/cache@v4
        with:
          path: |
            data/models
          key: ml-models-${{ github.run_number }}
          restore-keys: |
            ml-models-
      
      - name: Collect Odds and Generate Predictions
        run: python scripts/predict_today.py --days 2
      
      - name: Upload ATS Data
        uses: actions/upload-artifact@v4
        with:
          name: ats-data-${{ github.run_number }}
          path: |
            data/ats_tracking.json
            data/ats_accuracy.json
          retention-days: 90
      
      - name: Commit ATS Data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/ats_tracking.json data/ats_accuracy.json README.md || true
          git diff --staged --quiet || git commit -m "üìä Update predictions for $(date +%Y-%m-%d)"
          git push || echo "Nothing to push"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  check-results:
    name: Check Results & Update Accuracy
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'check_results' || github.event.inputs.action == 'both') || github.event.schedule == '0 4 * * *'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create .env file
        run: |
          echo "THE_ODDS_API_KEY=${{ secrets.THE_ODDS_API_KEY }}" > .env
          echo "BASKETBALL_API_KEY=${{ secrets.BASKETBALL_API_KEY }}" >> .env
      
      - name: Download existing ATS data
        uses: actions/cache@v4
        with:
          path: |
            data/ats_tracking.json
            data/ats_accuracy.json
            data/predictions.json
            data/results.json
          key: ats-data-${{ github.run_number }}
          restore-keys: |
            ats-data-

      - name: Cache ML models
        uses: actions/cache@v4
        with:
          path: |
            data/models
          key: ml-models-${{ github.run_number }}
          restore-keys: |
            ml-models-
      
      - name: Check Results
        run: python scripts/daily_check_results.py --days 7
      
      - name: Update README
        run: python scripts/update_readme_accuracy.py

      - name: Retrain ML model
        run: python scripts/setup_and_train.py --populate 200 --train
      
      - name: Upload Updated ATS Data
        uses: actions/upload-artifact@v4
        with:
          name: ats-data-results-${{ github.run_number }}
          path: |
            data/ats_tracking.json
            data/ats_accuracy.json
          retention-days: 90
      
      - name: Commit Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/ats_tracking.json data/ats_accuracy.json README.md || true
          git diff --staged --quiet || git commit -m "üìà Update accuracy stats: $(date +%Y-%m-%d)"
          git push || echo "Nothing to push"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-readme-only:
    name: Update README Only
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'update_readme'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download existing ATS data
        uses: actions/cache@v4
        with:
          path: |
            data/ats_tracking.json
            data/ats_accuracy.json
          key: ats-data-${{ github.run_number }}
          restore-keys: |
            ats-data-

      - name: Cache ML models
        uses: actions/cache@v4
        with:
          path: |
            data/models
          key: ml-models-${{ github.run_number }}
          restore-keys: |
            ml-models-
      
      - name: Update README
        run: python scripts/update_readme_accuracy.py
      
      - name: Commit README
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md || true
          git diff --staged --quiet || git commit -m "üìù Update README accuracy section"
          git push || echo "Nothing to push"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

